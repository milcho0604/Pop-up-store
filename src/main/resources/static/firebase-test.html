<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase FCM í† í° í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #fcmToken {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        .info {
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” Firebase FCM í† í° ë°œê¸‰ í…ŒìŠ¤íŠ¸</h1>

        <div class="section">
            <h3>1ë‹¨ê³„: FCM í† í° ë°œê¸‰</h3>
            <p class="info">ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•˜ê³  Firebaseë¡œë¶€í„° FCM í† í°ì„ ë°›ìŠµë‹ˆë‹¤.</p>
            <button id="requestPermission">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë° í† í° ë°œê¸‰</button>
            <div id="tokenResult" style="margin-top: 15px;"></div>
            <textarea id="fcmToken" rows="4" readonly placeholder="ì—¬ê¸°ì— FCM í† í°ì´ í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
        </div>

        <div class="section">
            <h3>2ë‹¨ê³„: ë°±ì—”ë“œì— í† í° ì €ì¥</h3>
            <p class="info">ë°œê¸‰ë°›ì€ FCM í† í°ì„ ë°±ì—”ë“œ ì„œë²„ì— ì €ì¥í•©ë‹ˆë‹¤. (JWT ì¸ì¦ í•„ìš”)</p>

            <div class="input-group">
                <label>JWT í† í° (ë¡œê·¸ì¸ í›„ ë°›ì€ í† í°):</label>
                <input type="text" id="jwtToken" placeholder="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>

            <button id="saveToken" disabled>ë°±ì—”ë“œì— í† í° ì €ì¥</button>
            <div id="saveResult" style="margin-top: 15px;"></div>
        </div>

        <div class="section">
            <h3>ğŸ“‹ í…ŒìŠ¤íŠ¸ ìˆœì„œ</h3>
            <ol>
                <li>ë¨¼ì € ë°±ì—”ë“œ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ì„¸ìš” (<code>./gradlew bootRun</code>)</li>
                <li>"ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë° í† í° ë°œê¸‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
                <li>ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ í—ˆìš© íŒì—…ì´ ëœ¨ë©´ "í—ˆìš©"ì„ í´ë¦­í•˜ì„¸ìš”</li>
                <li>FCM í† í°ì´ í™”ë©´ì— í‘œì‹œë©ë‹ˆë‹¤</li>
                <li>JWT í† í° ì…ë ¥ë€ì— ë¡œê·¸ì¸ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”</li>
                <li>"ë°±ì—”ë“œì— í† í° ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
            </ol>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

        let app = null;
        let messaging = null;
        let currentFcmToken = null;
        let firebaseConfig = null;

        // ë°±ì—”ë“œì—ì„œ Firebase ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        async function loadFirebaseConfig() {
            try {
                const response = await fetch('http://localhost:8080/api/firebase/config');
                if (!response.ok) {
                    throw new Error('Firebase ì„¤ì •ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                firebaseConfig = await response.json();
                console.log('âœ… Firebase ì„¤ì • ë¡œë“œ ì™„ë£Œ');

                // Firebase ì´ˆê¸°í™”
                app = initializeApp(firebaseConfig);
                console.log('âœ… Firebase ì•± ì´ˆê¸°í™” ì™„ë£Œ');

                return true;
            } catch (error) {
                console.error('âŒ Firebase ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('tokenResult').innerHTML = '<p class="error">âŒ Firebase ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>';
                document.getElementById('tokenResult').style.display = 'block';
                return false;
            }
        }

        // Service Worker ë“±ë¡ ë° Firebase Messaging ì´ˆê¸°í™”
        async function initializeFirebaseMessaging() {
            try {
                // Firebase ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
                if (!app) {
                    const configLoaded = await loadFirebaseConfig();
                    if (!configLoaded) {
                        return false;
                    }
                }

                // Service Worker ë“±ë¡
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ:', registration);

                // Service Workerê°€ í™œì„±í™”ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                await navigator.serviceWorker.ready;
                console.log('âœ… Service Worker í™œì„±í™” ì™„ë£Œ');

                // Firebase Messaging ì´ˆê¸°í™”
                messaging = getMessaging(app);
                console.log('âœ… Firebase Messaging ì´ˆê¸°í™” ì™„ë£Œ');

                // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                onMessage(messaging, (payload) => {
                    console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', payload);
                    alert(`ì•Œë¦¼: ${payload.notification.title}\n${payload.notification.body}`);
                });

                return true;
            } catch (error) {
                console.error('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ì„¤ì • ë¡œë“œ ë° Service Worker ë“±ë¡
        (async () => {
            await loadFirebaseConfig();
            await initializeFirebaseMessaging();
        })();

        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë° í† í° ë°œê¸‰
        document.getElementById('requestPermission').addEventListener('click', async () => {
            try {
                // Service Workerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¨¼ì € ì´ˆê¸°í™”
                if (!messaging) {
                    document.getElementById('tokenResult').innerHTML = '<p class="info">Service Workerë¥¼ ë“±ë¡í•˜ëŠ” ì¤‘...</p>';
                    const initialized = await initializeFirebaseMessaging();
                    if (!initialized) {
                        document.getElementById('tokenResult').innerHTML = '<p class="error">âŒ Service Worker ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                }

                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    document.getElementById('tokenResult').innerHTML = '<p class="info">ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤. í† í°ì„ ë°œê¸‰ë°›ëŠ” ì¤‘...</p>';

                    // ë°±ì—”ë“œì—ì„œ ë°›ì•„ì˜¨ VAPID í‚¤ ì‚¬ìš©
                    const token = await getToken(messaging, {
                        vapidKey: firebaseConfig.vapidKey
                    });

                    if (token) {
                        currentFcmToken = token;
                        document.getElementById('fcmToken').value = token;
                        document.getElementById('tokenResult').innerHTML = '<p class="success">âœ… FCM í† í° ë°œê¸‰ ì„±ê³µ!</p>';
                        document.getElementById('saveToken').disabled = false;

                        console.log('FCM Token:', token);
                    } else {
                        document.getElementById('tokenResult').innerHTML = '<p class="error">í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. VAPID í‚¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</p>';
                    }
                } else {
                    document.getElementById('tokenResult').innerHTML = '<p class="error">âŒ ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                if (error.code === 'messaging/unsupported-browser') {
                    document.getElementById('tokenResult').innerHTML = '<p class="error">âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” FCMì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome, Firefox, Edgeë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p>';
                } else if (error.code === 'messaging/failed-service-worker-registration') {
                    document.getElementById('tokenResult').innerHTML = '<p class="error">âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨. firebase-messaging-sw.js íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                } else {
                    document.getElementById('tokenResult').innerHTML = `<p class="error">âŒ ì—ëŸ¬: ${error.message}</p>`;
                }
            }
        });

        // ë°±ì—”ë“œì— í† í° ì €ì¥
        document.getElementById('saveToken').addEventListener('click', async () => {
            const jwtToken = document.getElementById('jwtToken').value.trim();

            if (!jwtToken) {
                document.getElementById('saveResult').innerHTML = '<p class="error">JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.</p>';
                return;
            }

            if (!currentFcmToken) {
                document.getElementById('saveResult').innerHTML = '<p class="error">FCM í† í°ì„ ë¨¼ì € ë°œê¸‰ë°›ìœ¼ì„¸ìš”.</p>';
                return;
            }

            try {
                document.getElementById('saveResult').innerHTML = '<p class="info">í† í°ì„ ì €ì¥í•˜ëŠ” ì¤‘...</p>';

                const response = await fetch('http://localhost:8080/fcm/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': jwtToken.startsWith('Bearer ') ? jwtToken : `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({
                        fcmToken: currentFcmToken
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('saveResult').innerHTML = `<p class="success">âœ… í† í° ì €ì¥ ì„±ê³µ!</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    document.getElementById('saveResult').innerHTML = `<p class="error">âŒ ì €ì¥ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>`;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('saveResult').innerHTML = `<p class="error">âŒ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: ${error.message}<br>ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.</p>`;
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì—ì„œ JWT í† í° ìë™ ì…ë ¥
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('jwtToken');
            if (savedToken) {
                document.getElementById('jwtToken').value = savedToken;
                console.log('âœ… ì €ì¥ëœ JWT í† í°ì„ ìë™ìœ¼ë¡œ ì…ë ¥í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    </script>
</body>
</html>
